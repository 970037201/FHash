#include <stdint.h>
#include <stddef.h>
#include "fhash.h"

// List of first 2048 prime numbers modulo 64 - for use with the hash function
const static uint8_t PRIMES[] = {2,3,5,7,11,13,17,19,23,29,31,37,41,43,47,53,59,61,3,7,9,15,19,25,33,37,39,43,45,49,63,3,9,11,21,23,29,35,39,45,51,53,63,1,5,7,19,31,35,37,41,47,49,59,1,7,13,15,21,25,27,37,51,55,57,61,11,17,27,29,33,39,47,53,59,63,5,13,17,25,35,37,47,49,55,59,1,9,13,15,19,31,39,43,51,55,61,9,11,29,35,45,51,57,59,1,11,17,23,25,31,37,41,43,55,1,3,7,13,19,21,33,37,43,51,61,5,15,23,29,35,39,47,53,57,1,5,19,29,41,43,53,55,59,61,7,21,25,27,31,45,49,51,55,11,15,23,33,41,45,51,57,7,11,17,23,31,37,49,53,59,61,7,9,15,25,27,37,39,45,63,3,5,9,15,21,29,35,41,63,1,11,19,29,35,41,49,61,1,7,13,15,21,33,43,61,63,3,9,11,17,21,23,27,39,41,47,17,23,29,37,55,1,15,19,21,25,31,39,43,45,51,63,9,11,15,17,21,27,39,51,59,7,13,17,23,31,35,43,47,61,1,7,9,13,19,21,27,37,57,63,3,5,29,33,35,45,57,59,5,13,19,25,31,49,55,59,61,9,19,31,39,55,5,11,15,17,21,23,33,45,51,57,11,13,29,31,53,59,3,9,13,15,19,27,33,43,45,55,5,15,21,33,35,39,41,51,63,1,17,19,25,29,31,41,49,3,27,31,37,45,61,63,3,11,27,29,33,41,47,53,57,5,7,29,35,37,43,47,53,3,9,13,15,21,25,31,43,49,55,5,9,15,27,35,41,45,7,25,35,43,47,53,55,61,19,31,33,49,57,61,9,23,33,35,39,47,53,59,63,1,5,11,19,23,25,31,41,43,53,61,1,15,25,37,39,45,49,51,3,17,21,27,35,41,45,63,7,17,23,29,37,47,59,9,13,19,25,27,55,57,3,11,15,29,33,41,53,59,7,11,17,37,47,49,1,27,31,33,45,51,55,3,9,17,21,29,51,53,57,59,7,35,37,43,49,55,59,1,3,15,19,31,33,43,45,61,63,15,21,41,57,1,5,7,11,13,35,43,55,61,7,9,13,19,21,27,37,39,51,61,63,9,23,29,33,39,47,53,59,11,23,25,29,43,49,53,61,7,15,21,27,49,55,57,3,17,21,27,45,47,57,7,11,13,23,37,41,49,3,7,13,15,19,25,27,39,43,63,21,33,35,39,45,51,53,59,17,19,25,41,47,59,61,3,15,31,33,37,43,57,61,63,17,41,51,57,59,5,7,17,19,29,35,37,47,49,59,1,9,39,49,51,61,5,11,21,39,45,57,5,7,25,31,35,41,47,1,3,13,27,33,37,39,43,3,5,17,23,39,47,53,59,13,29,31,35,41,43,49,55,1,7,19,31,49,51,57,61,15,23,47,51,53,57,63,1,13,17,31,61,7,13,25,39,45,55,3,5,9,15,23,29,39,41,45,59,1,7,11,17,19,29,31,47,59,3,21,25,31,43,45,51,57,63,27,33,47,51,59,5,13,25,43,47,49,53,13,25,31,33,49,55,61,11,21,35,39,5,11,17,23,31,37,41,43,55,61,1,3,9,31,37,39,43,61,63,3,15,17,23,27,53,59,1,5,13,23,55,7,9,15,19,21,25,27,37,51,57,61,5,15,21,41,45,47,53,19,23,31,41,47,53,61,3,15,19,25,27,33,37,43,45,55,57,9,15,35,39,51,1,29,35,55,59,13,21,27,31,37,51,57,63,9,11,21,33,41,51,53,63,7,19,29,53,55,59,3,9,13,21,39,49,55,61,63,5,15,27,29,39,45,51,57,1,7,17,23,25,31,37,43,53,61,21,27,49,51,5,9,17,27,57,1,19,23,25,35,41,43,49,53,7,15,27,45,61,3,5,17,23,33,35,45,47,53,63,13,17,41,43,59,61,7,9,19,39,43,45,49,57,9,15,21,23,35,51,59,63,5,35,37,47,49,55,59,1,7,15,21,25,37,43,51,63,3,17,29,39,63,5,17,23,25,47,55,9,19,25,39,43,45,51,61,5,11,15,21,51,1,11,13,25,35,37,53,55,9,33,51,57,9,27,33,35,53,57,63,1,11,19,29,35,41,49,53,59,61,7,9,21,25,31,37,39,51,55,5,23,27,33,53,57,1,7,11,19,23,37,43,47,61,9,13,15,45,49,9,15,21,33,45,59,1,5,7,11,29,35,47,55,61,1,13,15,27,57,9,11,17,39,53,59,5,17,23,25,29,37,47,53,59,19,33,39,43,51,63,17,27,29,39,41,45,51,7,13,17,31,35,37,41,55,61,9,33,43,49,57,3,5,35,39,45,47,59,63,13,19,53,1,9,15,25,27,31,51,61,5,21,23,33,47,51,53,1,7,23,29,37,41,49,53,59,3,9,15,27,33,37,43,49,57,11,15,35,39,51,53,63,5,7,17,29,31,35,55,61,27,33,37,45,55,3,9,11,39,41,47,51,53,5,17,19,25,35,43,3,15,21,39,45,49,63,5,9,21,29,35,47,51,57,5,11,23,25,41,61,1,3,13,31,39,43,57,61,63,5,27,33,47,53,59,5,11,13,23,25,29,31,53,55,59,1,7,19,25,39,49,61,3,11,15,51,1,13,19,23,29,31,43,49,61,13,15,25,33,55,57,5,11,15,21,39,41,53,59,63,11,19,25,37,41,47,59,1,3,15,27,31,45,51,3,9,11,21,29,47,53,23,25,53,55,13,19,21,31,43,45,51,55,63,21,27,29,39,47,51,57,1,5,17,35,47,3,7,13,19,27,31,33,49,61,63,9,17,27,29,33,39,53,1,23,31,59,61,1,21,25,27,31,45,55,3,5,17,33,35,63,7,29,37,41,47,53,3,7,15,27,33,39,43,63,3,21,23,35,41,45,51,1,19,29,37,47,15,21,31,37,43,45,51,3,9,11,23,29,57,59,5,13,29,35,43,49,59,19,39,49,51,61,63,11,15,21,41,45,47,59,13,23,25,35,37,41,61,13,39,43,51,57,61,9,15,23,35,47,53,57,1,23,25,41,55,1,7,19,31,45,51,55,11,15,27,33,35,41,47,63,7,29,31,59,3,9,13,33,37,49,9,29,33,41,51,53,5,7,19,31,1,3,7,13,25,31,37,45,51,55,57,63,23,27,47,57,63,5,19,23,29,35,37,49,55,1,3,13,19,39,43,5,9,11,17,39,41,1,5,11,13,17,23,47,53,61,1,3,37,43,51,3,15,17,27,29,39,45,53,57,1,13,35,41,55,59,21,25,27,39,49,57,61,5,17,21,35,41,57,63,7,11,17,23,31,37,47,59,61,3,9,25,33,39,45,57,3,5,11,29,33,39,45,51,63,17,25,31,41,49,3,7,21,27,45,55,63,9,21,23,29,41,53,25,29,35,43,47,53,55,59,13,25,31,39,45,51,55,9,11,15,17,41,45,51,57,7,37,43,47,53,1,7,27,31,39,43,51,57,63,3,33,35,45,57,1,11,19,43,49,61,1,15,19,25,27,55,5,21,23,35,41,45,1,11,17,23,29,37,47,59,9,19,33,49,63,9,23,29,45,51,59,1,17,37,47,49,55,59,61,1,13,15,25,27,33,55,61,63,3,21,29,39,47,5,7,17,35,49,53,55,59,13,15,19,25,33,43,45,11,15,45,47,57,59,13,17,35,41,55,1,3,7,27,63,5,9,15,29,33,53,63,13,35,41,43,9,21,31,49,51,55,5,11,33,51,53,1,7,11,19,23,31,37,47,49,61,15,25,39,55,5,9,15,21,23,29,33,35,63,1,29,35,37,41,47,61,1,13,27,43,57,61,3,11,17,21,27,33,39,47,51,59,63,13,29,37,43,47,59,3,19,21,31,39,43,49,11,17,27,35,39,45,57,7,37,41,55,13,21,33,37,43,51,61,3,17,27,33,35,45,57,5,19,25,31,49,59,1,9,27,31,37,39,45,55,57,3,11,17,23,33,35,53,63,1,13,17,23,31,41,53,3,15,19,27,37,43,49,5,9,23,39,53,63,7,17,29,31,49,55,3,13,25,27,31,33,45,51,55,63,3,47,51,53,57,59,5,17,23,29,43,47,53,59,1,9,15,51,5,9,15,17,29,35,41,47,51,1,23,35,37,55,1,7,33,57,61,63,3,5,9,23,27,33,39,47,63,11,13,55,59,61,1,25,31,37,39,57,61,11,17,45,63,13,19,29,41,43,49,61,27,33,37,43,49,63,3,5,29,33,39,45,7,17,35,41,49,55,61,27,31,43,55,57,9,11,17,21,33,51,53,59,63,25,37,43,55,59,19,43,55,61,63,11,39,47,51,57,5,7,25,31,35,41,47,3,19,21,27,33,51,61,3,5,9,17,23,29,53,5,11,19,29,35,49,7,15,31,37,39,51,55,57,15,23,41,11,13,19,37,41,47,53,61,7,15,33,39,43,45,49,57,9,11,23,35,41,59,63,5,11,17,19,25,37,47,3,15,33,37,43,45,61,63,9,23,27,57,59,5,17,19,43,49,1,9,19,21,33,55,61,63,15,35,45,47,59,7};

FHB FH_hash(const FHB block, const uint64_t rounds) {
    // Mixing function - adds, xors, rotates.
    #define MIX(a, b, c, s) a += b; c ^= a; c = (c << s) | (c >> (64 - s))
    // Copies original block for mixing with final result
    FHB mix = block;
    // Loops over each round
    for (uint64_t r = 0; r < rounds; r++) {
        // slide window across entire block, mixing A B and C together,
        // with a shift constant from the index of A offset by the round.
        uint64_t* x = mix.val;
        for (uint64_t a = 0; a < 2048; a++) {
            uint64_t b = a + 1, c = a + 2;
            uint64_t s = (uint64_t)PRIMES[(size_t)((a + r) % 2048)];
            MIX(x[a % 2048], x[b % 2048], x[c % 2048], s);
        }
    }
    // XOR with original block
    for (uint64_t i = 0; i < 2048; i++) {
        mix.val[i] ^= block.val[i];
    }
    return mix;
}

void FH_inc(FHB* block) {
    // Only increment block if it is not a null pointer
    if (block) {
        size_t i = 0;
        // Increment each section,
        // carry if the section just incremented is zero.
        do {
            block->val[i]++;
        } while (!block->val[i] && ++i < 2048);
    }
}
